<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>My Orders</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>

  <body class="bg-light">
    <div class="container mt-5">
      <h2 class="mb-4 fw-bold">My Orders</h2>

      <!-- No orders -->
      <div th:if="${orders.size() == 0}">
        <div class="alert alert-info">You have no orders yet.</div>
      </div>

      <!-- Orders table -->
      <table
        class="table table-bordered table-striped"
        th:if="${orders.size() > 0}"
      >
        <thead class="table-dark">
          <tr>
            <th>Order ID</th>
            <th>Date</th>
            <th>Total</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>

        <tbody>
          <tr th:each="order, iter : ${orders}">
            <td th:text="${order.id}"></td>

            <td>
              <span
                th:text="${#temporals.format(order.createdAt, 'dd MMM yyyy hh:mm a')}"
              ></span>
            </td>

            <td>₹ <span th:text="${order.totalAmount}"></span></td>

            <td>
              <span th:switch="${order.status.name()}">
                <span th:case="'PENDING'" class="badge bg-warning text-dark"
                  >PENDING</span
                >
                <span th:case="'PAID'" class="badge bg-success">PAID</span>
                <span th:case="'DELIVERED'" class="badge bg-primary"
                  >DELIVERED</span
                >
                <span th:case="'CANCELLED'" class="badge bg-danger"
                  >CANCELLED</span
                >
              </span>
            </td>

            <td>
              <!-- Expand item list -->
              <button
                class="btn btn-secondary btn-sm"
                data-bs-toggle="collapse"
                th:attr="data-bs-target='#items-'+${order.id}"
              >
                Items
              </button>

              <a
                th:href="@{'/order/confirmation'(id=${order.id})}"
                class="btn btn-primary btn-sm"
                >View</a
              >

              <a
                th:if="${order.status.name() == 'PENDING'}"
                th:href="@{'/order/cancel/' + ${order.id}}"
                class="btn btn-danger btn-sm"
              >
                Cancel
              </a>
            </td>
          </tr>

          <!-- Items Row (INSIDE LOOP NOW!) -->
          <tr
            th:each="order, iter : ${orders}"
            th:id="'items-' + ${order.id}"
            class="collapse bg-light"
          >
            <td colspan="5">
              <h6 class="fw-bold">
                Items for Order #<span th:text="${order.id}"></span>
              </h6>

              <table class="table table-sm table-bordered mt-3">
                <thead class="table-secondary">
                  <tr>
                    <th>Product</th>
                    <th>Qty</th>
                    <th>Price</th>
                    <th>Subtotal</th>
                  </tr>
                </thead>

                <tbody>
                  <tr th:each="item : ${order.items}">
                    <td th:text="${item.product.name}"></td>
                    <td th:text="${item.quantity}"></td>
                    <td>₹ <span th:text="${item.price}"></span></td>
                    <td>
                      ₹ <span th:text="${item.price * item.quantity}"></span>
                    </td>
                  </tr>
                </tbody>
              </table>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
